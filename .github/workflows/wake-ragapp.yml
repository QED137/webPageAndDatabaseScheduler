name: Wake Neo4j and Start RAG App

on:
  schedule:
    - cron: '0 6 * * *'  # Runs every day at 06:00 UTC (08:00 Germany)
  workflow_dispatch:     # Allow manual trigger

jobs:
  wake_and_start:
    runs-on: ubuntu-latest
    env:
      NEO4J_URI: ${{ secrets.NEO4J_URI }}
      NEO4J_USER: ${{ secrets.NEO4J_USER }}
      NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
      KAMATERA_API_KEY: ${{ secrets.KAMATERA_API_KEY }}
      KAMATERA_SERVER_ID: ${{ secrets.KAMATERA_SERVER_ID }}

    steps:
      - name: Checkout (optional, good practice)
        uses: actions/checkout@v4

      - name: Wake up Neo4j AuraDB
        run: |
          pip install neo4j
          python3 <<EOF
          from neo4j import GraphDatabase
          import time

          uri = "${{ env.NEO4J_URI }}"
          user = "${{ env.NEO4J_USER }}"
          password = "${{ env.NEO4J_PASSWORD }}"

          print("ðŸŒ Connecting to Neo4j...")
          driver = GraphDatabase.driver(uri, auth=(user, password))

          def wake_db(tx):
              result = tx.run("MATCH (n) RETURN count(n)")
              print("âœ… Neo4j responded with:", result.single())

          with driver.session() as session:
              session.execute_read(wake_db)
          driver.close()
          print("ðŸ§  AuraDB should now be awake.")
          EOF

      - name: Wait 30 seconds before starting VPS
        run: sleep 30

      - name: Start Kamatera VPS
        run: |
          curl -X POST https://console.kamatera.com/service/server/start \
            -H "X-API-Token: ${{ env.KAMATERA_API_KEY }}" \
            -d "serverId=${{ env.KAMATERA_SERVER_ID }}"
